generator client {
  provider = "prisma-client-js"
}

// Database Configuration
// Supports both local PostgreSQL and Azure Database for PostgreSQL Flexible Server
// Azure connections require SSL/TLS (use ?sslmode=require in DATABASE_URL)
// For local development: postgresql://user:password@localhost:5432/dbname
// For Azure: postgresql://dbadmin:password@studyhub-db.postgres.database.azure.com:5432/dbname?sslmode=require
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int           @id @default(autoincrement())
  fullName            String
  email               String        @unique
  passwordHash        String
  role                Role          @default(USER)
  resetToken          String?       @unique
  resetTokenExpiresAt DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  // Profile fields
  avatar              String?
  bio                 String?
  location            String?
  institution         String?
  fieldOfStudy        String?
  website             String?
  interests           String[]      @default([])
  
  summaries     Summary[]     @relation("UserSummaries")
  ratings       Rating[]
  comments      Comment[]
  forumPosts    ForumPost[]
  forumComments ForumComment[]
  forumRatings  ForumRating[]
  tools         Tool[]
  toolRatings   ToolRating[]
  helpRequests  HelpRequest[]
  favorites     Favorite[]
  
  @@map("users")
}

enum Role {
  USER
  ADMIN
}

model Course {
  id           Int           @id @default(autoincrement())
  courseCode   String        @unique
  courseName   String
  institution  String
  semester     String
  createdAt    DateTime      @default(now())
  
  summaries    Summary[]
  forumPosts   ForumPost[]
  helpRequests HelpRequest[]
  
  @@map("courses")
}

model Summary {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  filePath    String
  uploadDate  DateTime  @default(now())
  avgRating   Float?
  
  courseId    Int
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  uploadedById Int
  uploadedBy   User     @relation("UserSummaries", fields: [uploadedById], references: [id], onDelete: Cascade)
  
  ratings     Rating[]
  comments    Comment[]
  favorites   Favorite[]
  
  @@map("summaries")
}

model Rating {
  id        Int      @id @default(autoincrement())
  rating    Int      // 1-5
  date      DateTime @default(now())
  
  summaryId Int
  summary   Summary  @relation(fields: [summaryId], references: [id], onDelete: Cascade)
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([summaryId, userId])
  @@map("ratings")
}

model Comment {
  id        Int      @id @default(autoincrement())
  text      String
  createdAt DateTime @default(now())
  
  summaryId Int?
  summary   Summary? @relation(fields: [summaryId], references: [id], onDelete: Cascade)
  
  authorId  Int
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  @@map("comments")
}

model ForumPost {
  id         Int      @id @default(autoincrement())
  title      String
  content    String
  category   String?
  tags       String[] @default([])
  images     String[] @default([])
  isUrgent   Boolean  @default(false)
  views      Int      @default(0)
  isAnswered Boolean  @default(false)
  avgRating  Float?
  createdAt  DateTime @default(now())
  
  courseId   Int
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  authorId   Int
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  comments   ForumComment[]
  ratings    ForumRating[]
  
  @@map("forum_posts")
}

model ForumComment {
  id        Int      @id @default(autoincrement())
  text      String
  createdAt DateTime @default(now())
  
  postId    Int
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  authorId  Int
  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  @@map("forum_comments")
}

model ForumRating {
  id        Int      @id @default(autoincrement())
  rating    Int      // 1-5
  createdAt DateTime @default(now())
  
  postId    Int
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  userId    Int
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([postId, userId])
  @@map("forum_ratings")
}

model Tool {
  id          Int      @id @default(autoincrement())
  title       String
  url         String
  description String?
  category    String?
  avgRating   Float?
  createdAt   DateTime @default(now())
  
  addedById   Int
  addedBy     User     @relation(fields: [addedById], references: [id], onDelete: Cascade)
  
  favorites   Favorite[]
  ratings     ToolRating[]
  
  @@map("tools")
}

model HelpRequest {
  id        Int      @id @default(autoincrement())
  title     String
  details   String?
  status    String   @default("open") // open, closed
  createdAt DateTime @default(now())
  
  authorId  Int
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  courseId  Int
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@map("help_requests")
}

model Favorite {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  summaryId Int?
  summary   Summary? @relation(fields: [summaryId], references: [id], onDelete: Cascade)
  
  toolId    Int?
  tool      Tool?    @relation(fields: [toolId], references: [id], onDelete: Cascade)
  
  @@unique([userId, summaryId])
  @@unique([userId, toolId])
  @@map("favorites")
}

model ToolRating {
  id        Int      @id @default(autoincrement())
  rating    Int      // 1-5
  createdAt DateTime @default(now())
  
  toolId    Int
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)
  
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([toolId, userId])
  @@map("tool_ratings")
}