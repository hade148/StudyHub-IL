# תיעוד תכונת דירוג כלים

## סקירה כללית
תכונה זו מאפשרת למשתמשים לדרג כלים אקדמיים בסולם של 1-5 כוכבים, בדומה לתכונת הדירוג הקיימת עבור סיכומים ופוסטים בפורום.

## מה נוסף?

### 1. עדכון מבנה בסיס הנתונים

#### טבלה חדשה: ToolRating (דירוגי כלים)
- שומרת את דירוג המשתמש לכלי
- דירוג בין 1-5
- הגבלה: דירוג אחד למשתמש לכל כלי

#### עדכון טבלת כלים (Tools)
- הוספת שדה `avgRating` - דירוג ממוצע
- קישור לטבלת הדירוגים

#### מיגרציה
קובץ SQL נוצר ב-`server/prisma/migrations/add_tool_ratings.sql` שמבצע:
- הוספת עמודה `avgRating` לטבלת `tools`
- יצירת טבלת `tool_ratings` חדשה
- הוספת אילוצים והגבלות

### 2. Backend - צד שרת

#### נקודות קצה חדשות

##### POST /api/tools/:id/rate
דירוג או עדכון דירוג של כלי.

**דרישות**: התחברות נדרשת

**בקשה**:
```json
{
  "rating": 5
}
```

**תגובה**:
```json
{
  "message": "דירוג נשמר בהצלחה",
  "rating": {
    "id": 1,
    "rating": 5,
    "toolId": 1,
    "userId": 1
  },
  "avgRating": 4.5
}
```

**תכונות**:
- יצירה או עדכון דירוג קיים
- חישוב מחדש של דירוג ממוצע
- עדכון שדה avgRating בכלי
- דירוג אחד למשתמש לכל כלי

##### GET /api/tools/:id/ratings
קבלת כל הדירוגים של כלי.

**דרישות**: אופציונלי (מחזיר userRating רק אם מחובר)

**תגובה**:
```json
{
  "ratings": [
    {
      "id": 1,
      "rating": 5,
      "createdAt": "2025-12-23T19:25:12.000Z",
      "user": {
        "id": 1,
        "fullName": "שם משתמש"
      }
    }
  ],
  "avgRating": 4.5,
  "userRating": 5,
  "totalRatings": 10
}
```

#### עדכון נקודות קצה קיימות

##### GET /api/tools
- כולל כעת מספר דירוגים (`ratingCount`) עבור כל כלי

##### GET /api/tools/:id
- כולל נתוני דירוגים בתגובה
- כולל ספירת דירוגים

### 3. Frontend - צד לקוח

#### רכיב חדש: ToolDetailDialog
**מיקום**: `client/src/components/tools/ToolDetailDialog.tsx`

חלון דיאלוג מודאלי שמציג מידע מפורט על כלי ומאפשר דירוג.

**תכונות**:
- מערכת דירוג אינטראקטיבית עם 5 כוכבים
- תצוגה מקדימה על ריחוף
- הצגת הדירוג הנוכחי של המשתמש
- הצגת דירוג ממוצע ומספר כולל של דירוגים
- משוב ויזואלי במהלך שליחה
- כפתור מועדפים
- קישור ישיר לשימוש בכלי
- מידע על מי הוסיף את הכלי ומתי

#### עדכון רכיבים קיימים

##### ToolCard (כרטיס כלי)
**מיקום**: `client/src/components/tools/ToolCard.tsx`

**עדכונים**:
- הוספת תווית דירוג עם אייקון כוכב
- פורמט: "⭐ 4.5 (10)" - מציג ממוצע וספירה
- פתיחת דיאלוג פרטים בלחיצה על הכרטיס

##### ToolsPage (עמוד כלים)
**מיקום**: `client/src/components/tools/ToolsPage.tsx`

**עדכונים**:
- עדכון ממשק Tool להכיל שדות דירוג
- הוספת state לכלי נבחר
- שילוב רכיב ToolDetailDialog
- העברת callback לרענון נתונים לאחר דירוג

### 4. חוויית משתמש

#### למשתמשים מחוברים
1. צפייה ברשימת כלים עם דירוגים ממוצעים וספירות
2. לחיצה על כרטיס כלי לפתיחת חלון פרטים
3. צפייה בדירוג הקודם שלהם (אם קיים) מסומן בכוכבים
4. ריחוף מעל כוכבים לתצוגה מקדימה
5. לחיצה על כוכב לשליחת דירוג
6. עדכון מיידי של הממשק עם ממוצע חדש ואישור
7. אפשרות לעדכן את הדירוג בכל עת

#### למשתמשים לא מחוברים
1. צפייה ברשימת כלים עם דירוגים ממוצעים וספירות
2. לחיצה על כרטיס כלי לפתיחת חלון פרטים
3. צפייה בכוכבי דירוג אך הם מושבתים
4. צפייה בדירוג ממוצע ובספירה כוללת
5. התראה להתחבר בניסיון לדרג

### 5. תכונות UI/UX

#### משוב ויזואלי
- ⭐ אייקוני כוכבים משנים צבע על ריחוף
- כוכבים צהובים ממולאים לדירוגים פעילים
- כוכבים אפורים לא פעילים
- מעברים חלקים ואפקטי scale
- מצב טעינה במהלך שליחה
- הודעת הצלחה לאחר דירוג

#### עיצוב רספונסיבי
- מודאל עובד על מובייל ודסקטופ
- כפתורי כוכבים ידידותיים למגע
- אזור תוכן הניתן לגלילה
- ריווח ופריסה נכונים

#### תמיכה ב-RTL
- כל הטקסט בעברית
- פריסה מימין לשמאל נשמרת
- יישור וריווח נכונים

## בטיחות ואבטחה

### אימות והרשאות
- ✅ שליחת דירוג דורשת JWT token תקף
- ✅ משתמשים יכולים רק לדרג כלים, לא למחוק אותם
- ✅ דירוג אחד למשתמש לכל כלי (אילוץ DB)

### ולידציה
- ✅ ערכי דירוג מאומתים (טווח 1-5)
- ✅ ניקוי קלט דרך express-validator
- ✅ בדיקת טיפוסים ב-TypeScript

### שלמות נתונים
- ✅ אילוצי foreign key מבטיחים שלמות רפרנציאלית
- ✅ מחיקה מדורגת (cascade) מסירה דירוגים כשכלי או משתמש נמחקים
- ✅ אילוץ ייחודיות מונע דירוגים כפולים

## בדיקות

### קובץ בדיקות
**מיקום**: `server/tests/tools-rating.test.js`

**כיסוי**:
1. POST /api/tools/:id/rate
   - דירוג כלי בהצלחה
   - עדכון דירוג קיים
   - דחיית דירוג ללא אימות
   - דחיית ערך דירוג לא תקין

2. GET /api/tools/:id/ratings
   - קבלת דירוגים של כלי
   - עבודה ללא אימות

3. GET /api/tools
   - הכללת ספירת דירוגים בתגובה

### הרצת בדיקות
```bash
cd server
npm test -- tests/tools-rating.test.js
```

**הערה**: הבדיקות דורשות חיבור למסד נתונים עם סכמה מתאימה.

## הוראות מיגרציה של בסיס הנתונים

להחלת השינויים במסד הנתונים:

### אופציה 1: שימוש ב-Prisma Migrate (מומלץ)
```bash
cd server
DATABASE_URL="your-connection-string" npx prisma migrate dev --name add-tool-ratings
```

### אופציה 2: הרצה ידנית של SQL
הרץ את ה-SQL מ-`server/prisma/migrations/add_tool_ratings.sql`

### יצירת Prisma Client
לאחר המיגרציה:
```bash
cd server
npx prisma generate
```

## דוגמאות שימוש ב-API

### דירוג כלי
```bash
curl -X POST http://localhost:4000/api/tools/1/rate \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"rating": 5}'
```

### קבלת דירוגי כלי
```bash
curl http://localhost:4000/api/tools/1/ratings
```

### קבלת כלים עם דירוגים
```bash
curl http://localhost:4000/api/tools
```

## קבצים ששונו

### Backend
- `server/prisma/schema.prisma` - הוספת מודל ToolRating ועדכון מודל Tool
- `server/prisma/migrations/add_tool_ratings.sql` - קובץ SQL למיגרציה
- `server/src/middleware/validation.js` - הוספת toolRatingValidation
- `server/src/routes/tools.js` - הוספת נקודות קצה לדירוג

### Frontend
- `client/src/components/tools/ToolCard.tsx` - הצגת דירוגים
- `client/src/components/tools/ToolsPage.tsx` - שילוב דיאלוג פרטים
- `client/src/components/tools/ToolDetailDialog.tsx` - רכיב חדש לדירוג

### בדיקות
- `server/tests/tools-rating.test.js` - חבילת בדיקות מקיפה

### תיעוד
- `TOOL_RATING_FEATURE.md` - תיעוד באנגלית
- `TOOL_RATING_FEATURE_HE.md` - תיעוד זה בעברית

## שיפורים עתידיים

שיפורים אפשריים:
1. ניתוח דירוגים בפאנל ניהול
2. קטע "כלים בעלי דירוג גבוה"
3. מגמות דירוג לאורך זמן
4. פירוק דירוגים לפי קטגוריה
5. היסטוריית דירוגי משתמש
6. דירוגי חצי כוכב (0.5)
7. דירוג עם ביקורת טקסטואלית
8. סינון/מיון כלים לפי דירוג

## פתרון בעיות

### בעיות חיבור למסד נתונים
וודא ש-`DATABASE_URL` מוגדר בקובץ `.env`:
```
DATABASE_URL="postgresql://username:password@localhost:5432/studyhub_db?schema=public"
```

### Prisma Client לא נוצר
הרץ:
```bash
cd server
npx prisma generate
```

### שגיאות TypeScript
וודא שכל התלויות מותקנות:
```bash
cd client
npm install
```

## סיכום

תכונת דירוג הכלים משולבת כעת במלואה ב-StudyHub-IL, ומספקת למשתמשים את היכולת לדרג ולסקור כלים אקדמיים. היישום עוקב אחר הדפוסים הקיימים לדירוג סיכומים ופוסטים בפורום, ומבטיח עקביות ברחבי הפלטפורמה.

---

**תאריך יישום**: 23 בדצמבר 2025
**סטטוס**: ✅ הושלם ונבדק
